@page "/history"
@attribute [StreamRendering]
@rendermode InteractiveServer
@using ContainerInspectionApp.Services
@using ContainerInspectionApp.Models
@inject ContainerTableOperations ContainerTableOperations

<PageTitle>Container History</PageTitle>
<MudText Typo="Typo.h3" GutterBottom="true">Container History</MudText>

@if (!_isDatabaseConnected)
{
    <MudAlert Severity="Severity.Error">
        Unable to connect to the database. Error: @_connectionError
    </MudAlert>
}
else
{
    <MudTable Items="@containers" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>Container ID</MudTh>
            <MudTh>Container Type</MudTh>
            <MudTh>Contents</MudTh>
            <MudTh>Date Added</MudTh>
            <MudTh>Location</MudTh>
            <MudTh>Status</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Container ID">@context.ContainerId</MudTd>
            <MudTd DataLabel="Container Type">@context.ContainerType</MudTd>
            <MudTd DataLabel="Contents">@context.Contents</MudTd>
            <MudTd DataLabel="Date Added">@(context.DateAdded?.ToShortDateString() ?? "N/A")</MudTd>
            <MudTd DataLabel="Location">@context.Location</MudTd>
            <MudTd DataLabel="Status">@context.Status</MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool _isDatabaseConnected = true;
    private string _connectionError = string.Empty;
    private List<Container> containers = new List<Container>();

    protected override async Task OnInitializedAsync()
    {
        var (success, errorMessage) = await ContainerTableOperations.TestConnection();
        _isDatabaseConnected = success;
        _connectionError = errorMessage;
        if (_isDatabaseConnected)
        {
            await LoadContainers();
        }
    }

    private async Task LoadContainers()
    {
        containers = await ContainerTableOperations.GetAllContainers();
    }
}